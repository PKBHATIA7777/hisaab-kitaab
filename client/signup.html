<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sign up - Hisaab-Kitaab</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text x='50%' y='65%' text-anchor='middle' font-size='80' fill='%23d000ff' font-family='Arial, sans-serif'>‚Çπ</text></svg>">
  <link rel="stylesheet" href="css/base.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div class="bubble-container">
    <div class="bubble"></div><div class="bubble"></div><div class="bubble"></div>
    <div class="bubble"></div><div class="bubble"></div><div class="bubble"></div>
  </div>

  <div class="brand-header">
    <h1>Hisaab-Kitaab</h1>
    <p>Your way of handling expenses</p>
  </div>

  <main id="main-content">
    <div class="auth-wrapper">
      <section class="auth-card" style="overflow: hidden; position: relative; min-height: 400px;">
        
        <div id="step-1" class="step-wrapper step-active">
          <h1 class="auth-title">Create Account</h1>
          <p class="auth-subtitle">Enter your email to get started</p>

          <form id="form-email" onsubmit="handleEmailSubmit(event)">
            <label>
              Email address
              <input type="email" name="email" id="input-email" required autocomplete="email" placeholder="john@example.com">
            </label>
            <button type="submit" class="btn-primary" id="btn-email">Send Verification Code</button>
          </form>

          <div style="margin-top: 20px;">
            <div class="g_id_signin" data-type="standard" data-shape="rectangular" data-theme="filled_black" data-text="signup_with" data-size="large" data-logo_alignment="left" data-width="100%"></div>
          </div>

          <p style="margin-top:20px; font-size:0.9rem; color:#666;">
            Already have an account? <a href="login.html">Log in</a>
          </p>
        </div>

        <div id="step-2" class="step-wrapper step-hidden-right">
          <button type="button" class="btn-text" onclick="goBackToStep1()">‚Üê Back</button>
          <h1 class="auth-title">Check your Inbox</h1>
          <p class="auth-subtitle">We sent a code to <span id="display-email" style="font-weight:600"></span></p>

          <form id="form-otp" onsubmit="handleOtpSubmit(event)">
            <label>
              Enter 6-digit Code
              <input type="text" name="otp" id="input-otp" inputmode="numeric" autocomplete="one-time-code" placeholder="123456" maxlength="6" style="letter-spacing: 4px; font-size: 1.2rem; text-align: center;">
            </label>
            <button type="submit" class="btn-primary" id="btn-otp">Verify Email</button>
          </form>

          <p style="text-align:center; margin-top:15px;">
            <button type="button" id="btn-resend" class="btn-text" onclick="resendOtp()">Resend Code</button>
          </p>
        </div>

        <div id="step-3" class="step-wrapper step-hidden-right">
          <h1 class="auth-title">One Last Thing</h1>
          <p class="auth-subtitle">Finish setting up your profile</p>

          <form id="form-details" onsubmit="handleDetailsSubmit(event)">
            <label>
              Full Name
              <input type="text" name="realName" required autocomplete="name" placeholder="John Doe" id="input-name">
            </label>
            <label>
              Create Password
              <div class="password-wrapper">
                <input type="password" name="password" required autocomplete="new-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <button type="button" class="btn-toggle-pass" tabindex="-1">üëÅÔ∏è</button>
              </div>
            </label>
            <button type="submit" class="btn-primary" id="btn-finish">Create Account</button>
          </form>
        </div>

      </section>
    </div>
  </main>

  <script src="js/main.js"></script>
  <script>
    // --- STATE ---
    let signupEmail = "";
    const els = {
      step1: document.getElementById('step-1'),
      step2: document.getElementById('step-2'),
      step3: document.getElementById('step-3'),
      inputEmail: document.getElementById('input-email'),
      inputOtp: document.getElementById('input-otp'),
      inputName: document.getElementById('input-name'),
      displayEmail: document.getElementById('display-email'),
      btnResend: document.getElementById('btn-resend')
    };

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
      if(window.initPasswordToggles) initPasswordToggles();
      els.inputEmail.focus();
    });

    // --- STEP 1: EMAIL ---
    async function handleEmailSubmit(e) {
      e.preventDefault();
      const email = els.inputEmail.value.trim();
      const btn = document.getElementById('btn-email');

      if(!email) return;
      setBtnLoading(btn, true);

      try {
        await apiFetch("/auth/register/request-otp", {
            method: "POST",
            body: { email }
        });

        // Success -> Move to Step 2
        signupEmail = email;
        els.displayEmail.textContent = email;
        
        slide(els.step1, els.step2);
        
        // Auto-focus OTP
        setTimeout(() => els.inputOtp.focus(), 400);
        startResendTimer();

      } catch (err) {
        showToast(err.message, "error");
        document.querySelector('.auth-card').classList.add('shake-card');
        setTimeout(() => document.querySelector('.auth-card').classList.remove('shake-card'), 500);
      } finally {
        setBtnLoading(btn, false);
      }
    }

    // --- STEP 2: OTP ---
    
    // Auto-Submit Logic
    els.inputOtp.addEventListener('input', (e) => {
      if (e.target.value.length === 6) {
        document.getElementById('form-otp').requestSubmit();
        els.inputOtp.blur();
      }
    });

    async function handleOtpSubmit(e) {
      e.preventDefault();
      const otp = els.inputOtp.value;
      const btn = document.getElementById('btn-otp');
      setBtnLoading(btn, true);

      try {
        await apiFetch("/auth/register/verify-otp", {
          method: "POST",
          body: { email: signupEmail, otp }
        });

        // Success -> Move to Step 3
        slide(els.step2, els.step3);
        setTimeout(() => els.inputName.focus(), 400);

      } catch (err) {
        showToast("Invalid code", "error");
        els.inputOtp.classList.add('shake-card'); // shake input
        setTimeout(() => els.inputOtp.classList.remove('shake-card'), 500);
        els.inputOtp.value = "";
      } finally {
        setBtnLoading(btn, false);
      }
    }

    // --- STEP 3: DETAILS ---
    async function handleDetailsSubmit(e) {
      e.preventDefault();
      const formData = new FormData(document.getElementById('form-details'));
      const btn = document.getElementById('btn-finish');
      setBtnLoading(btn, true);

      try {
        await apiFetch("/auth/register/complete", {
          method: "POST",
          body: {
            realName: formData.get("realName"),
            password: formData.get("password")
            // No username sent!
          }
        });

        if (navigator.vibrate) navigator.vibrate([10, 30, 10]);
        window.location.href = "dashboard.html";

      } catch (err) {
        showToast(err.message, "error");
      } finally {
        setBtnLoading(btn, false);
      }
    }

    // --- UTILS ---
    function slide(fromEl, toEl) {
      fromEl.classList.replace('step-active', 'step-hidden-left');
      toEl.classList.replace('step-hidden-right', 'step-active');
    }

    function goBackToStep1() {
      els.step2.classList.replace('step-active', 'step-hidden-right');
      els.step1.classList.replace('step-hidden-left', 'step-active');
      setTimeout(() => els.inputEmail.focus(), 100);
    }

    let resendTimer = null;
    function startResendTimer() {
      let count = 60;
      els.btnResend.disabled = true;
      els.btnResend.textContent = `Resend in ${count}s`;
      
      if(resendTimer) clearInterval(resendTimer);
      
      resendTimer = setInterval(() => {
        count--;
        if(count <= 0) {
          clearInterval(resendTimer);
          els.btnResend.disabled = false;
          els.btnResend.textContent = "Resend Code";
        } else {
          els.btnResend.textContent = `Resend in ${count}s`;
        }
      }, 1000);
    }

    async function resendOtp() {
       try {
         await apiFetch("/auth/register/request-otp", {
            method: "POST",
            body: { email: signupEmail }
         });
         showToast("Code resent!");
         startResendTimer();
       } catch(err) {
         showToast(err.message, "error");
       }
    }
  </script>
</body>
</html>